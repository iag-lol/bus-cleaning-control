# Gu√≠a de Instalaci√≥n y Ejecuci√≥n

## Sistema Completo de Control de Aseo de Buses

Esta gu√≠a te llevar√° paso a paso para ejecutar el sistema completo.

---

## üìã Requisitos Previos

### Opci√≥n 1: Con Docker (RECOMENDADO - M√°s F√°cil)
- [Docker Desktop](https://www.docker.com/products/docker-desktop) instalado
- [Docker Compose](https://docs.docker.com/compose/install/) (incluido con Docker Desktop)

### Opci√≥n 2: Sin Docker (Desarrollo Local)
- Python 3.11+
- Node.js 18+
- PostgreSQL 14+
- Redis (opcional)

---

## üöÄ Inicio R√°pido con Docker (5 minutos)

### Paso 1: Clonar o Navegar al Proyecto

```bash
cd bus-cleaning-control
```

### Paso 2: Configurar Variables de Entorno

#### Backend
```bash
cp backend/.env.example backend/.env
```

Abre `backend/.env` y verifica que todo est√© correcto. Las configuraciones por defecto funcionan para desarrollo local con Docker.

#### Frontend
```bash
cp frontend/.env.example frontend/.env
```

Las configuraciones por defecto del frontend tambi√©n funcionan.

### Paso 3: Levantar Todos los Servicios

```bash
docker compose up -d
```

Este comando har√°:
- ‚úÖ Descargar las im√°genes necesarias (PostgreSQL, Redis, etc.)
- ‚úÖ Construir el backend y frontend
- ‚úÖ Crear la base de datos
- ‚úÖ Crear el usuario administrador
- ‚úÖ Levantar todos los servicios

**Primera vez**: Puede tomar 3-5 minutos descargando dependencias.

### Paso 4: Verificar que Todo Est√© Corriendo

```bash
docker compose ps
```

Deber√≠as ver 4 servicios corriendo:
- ‚úÖ `bus-cleaning-db` (PostgreSQL)
- ‚úÖ `bus-cleaning-redis` (Redis)
- ‚úÖ `bus-cleaning-backend` (FastAPI)
- ‚úÖ `bus-cleaning-frontend` (React)

### Paso 5: Acceder a la Aplicaci√≥n

Abre tu navegador y ve a:

**Frontend (Aplicaci√≥n Principal)**
```
http://localhost:5173
```

**Backend API (Documentaci√≥n Swagger)**
```
http://localhost:8000/docs
```

**Credenciales por Defecto:**
- Email: `admin@buses.cl`
- Password: `Admin123!`

‚ö†Ô∏è **IMPORTANTE**: Cambia estas credenciales inmediatamente en producci√≥n.

### Paso 6: Ver Logs (si hay problemas)

```bash
# Ver logs de todos los servicios
docker compose logs -f

# Ver logs solo del backend
docker compose logs -f backend

# Ver logs solo del frontend
docker compose logs -f frontend
```

### Paso 7: Detener los Servicios

```bash
# Detener sin eliminar datos
docker compose stop

# Detener y eliminar contenedores (mantiene datos)
docker compose down

# Eliminar TODO (contenedores, vol√∫menes, datos)
docker compose down -v
```

---

## üõ†Ô∏è Instalaci√≥n Sin Docker (Desarrollo Local)

### Backend

1. **Navegar al directorio backend**
```bash
cd backend
```

2. **Crear entorno virtual**
```bash
python -m venv venv

# Activar en Linux/Mac:
source venv/bin/activate

# Activar en Windows:
venv\Scripts\activate
```

3. **Instalar dependencias**
```bash
pip install -r requirements.txt
```

4. **Configurar variables de entorno**
```bash
cp .env.example .env
```

Edita `.env` y configura tu base de datos local:
```env
DATABASE_URL=postgresql+asyncpg://tu_usuario:tu_password@localhost:5432/bus_cleaning
```

5. **Crear base de datos PostgreSQL**
```sql
CREATE DATABASE bus_cleaning;
```

6. **Crear usuario administrador**
```bash
python -m app.scripts.create_admin
```

7. **Ejecutar servidor de desarrollo**
```bash
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

Backend disponible en: `http://localhost:8000`

### Frontend

1. **Navegar al directorio frontend**
```bash
cd frontend
```

2. **Instalar dependencias**
```bash
npm install
```

3. **Configurar variables de entorno**
```bash
cp .env.example .env
```

4. **Ejecutar servidor de desarrollo**
```bash
npm run dev
```

Frontend disponible en: `http://localhost:5173`

---

## üì± Uso de la Aplicaci√≥n

### Vista M√≥vil (Operario)

1. **Acceder desde m√≥vil o desktop** en `http://localhost:5173`
2. **Iniciar sesi√≥n** con las credenciales de admin (o crear usuario operario)
3. **Ir a "Inspecci√≥n"** (vista principal de operario)
4. **Seleccionar PPU**: Buscar un bus existente o crear uno nuevo
5. **Permitir c√°mara**: El navegador pedir√° permiso
6. **An√°lisis autom√°tico**: El sistema analiza cada 500ms autom√°ticamente
7. **Ver resultado**: Badge muestra LIMPIO/SUCIO/DUDOSO con sugerencias
8. **Agregar observaciones**: Escribir notas adicionales (opcional)
9. **Enviar**: Presionar bot√≥n "Enviar Registro"

### Panel Administrativo

1. **Ir a "Dashboard"** en el men√∫
2. **Ver estad√≠sticas** en tiempo real
3. **Reportes**: Filtrar y exportar CSV/PDF
4. **Alertas**: Ver y resolver alertas autom√°ticas
5. **Gesti√≥n**: Administrar PPUs y usuarios

---

## üîß Soluci√≥n de Problemas

### La c√°mara no funciona

**Problema**: "getUserMedia() no est√° disponible"

**Soluciones**:
1. Usa HTTPS en producci√≥n (c√°mara requiere contexto seguro)
2. En desarrollo, usa `localhost` (es seguro)
3. Verifica permisos del navegador
4. Usa el bot√≥n "Subir Foto" como alternativa

### Error de conexi√≥n al backend

**Problema**: "Network Error" o "CORS Error"

**Soluciones**:
1. Verifica que el backend est√© corriendo: `docker compose ps`
2. Revisa logs: `docker compose logs backend`
3. Verifica `BACKEND_CORS_ORIGINS` en `backend/.env`
4. Aseg√∫rate que la URL en `frontend/.env` sea correcta

### Base de datos no conecta

**Problema**: "Connection refused" en PostgreSQL

**Soluciones con Docker**:
```bash
# Reiniciar servicios
docker compose restart db backend

# Ver logs de la base de datos
docker compose logs db
```

**Soluciones sin Docker**:
1. Verifica que PostgreSQL est√© corriendo
2. Verifica credenciales en `.env`
3. Prueba conexi√≥n: `psql -U tu_usuario -d bus_cleaning`

### El modelo de IA no carga

**Soluci√≥n**: El sistema usa un clasificador dummy por defecto (configurado con `ML_USE_DUMMY=true`). Este es perfecto para desarrollo y testing. Para usar un modelo real:

1. Entrena o descarga un modelo ONNX
2. Col√≥calo en `backend/ml/models/cleaning_classifier.onnx`
3. Cambia `ML_USE_DUMMY=false` en `backend/.env`
4. Reinicia el backend

---

## üß™ Testing

### Backend

```bash
cd backend
pytest                           # Todos los tests
pytest --cov=app tests/          # Con coverage
pytest tests/api/test_auth.py    # Test espec√≠fico
```

### Frontend

```bash
cd frontend
npm run test                     # Unit tests (Vitest)
npm run test:e2e                 # E2E tests (Playwright)
```

---

## üåê Despliegue en Producci√≥n

### Checklist Pre-Producci√≥n

- [ ] Cambiar `SECRET_KEY` en `backend/.env` (generar nuevo con `openssl rand -hex 32`)
- [ ] Cambiar password de admin
- [ ] Configurar CORS correctamente (solo dominios permitidos)
- [ ] Usar PostgreSQL real (no SQLite)
- [ ] Configurar backups autom√°ticos de base de datos
- [ ] Habilitar HTTPS/SSL (nginx o Caddy)
- [ ] Configurar rate-limiting
- [ ] Configurar logging y monitoreo
- [ ] Probar notificaciones Web Push con VAPID keys reales
- [ ] Validar funcionamiento offline

### Producci√≥n con Docker

```bash
# Build para producci√≥n
docker compose -f docker-compose.yml -f docker-compose.prod.yml build

# Ejecutar en producci√≥n
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
```

### Variables de Entorno para Producci√≥n

**Backend** (`.env`):
```env
ENVIRONMENT=production
DEBUG=false
SECRET_KEY=<generar-nuevo-con-openssl>
DATABASE_URL=postgresql+asyncpg://user:password@host:5432/db
BACKEND_CORS_ORIGINS=https://tu-dominio.com
ML_USE_DUMMY=false
```

**Frontend** (`.env`):
```env
VITE_API_URL=https://api.tu-dominio.com
VITE_WS_URL=wss://api.tu-dominio.com
```

---

## üìö Recursos Adicionales

### Documentaci√≥n API

- Swagger UI: `http://localhost:8000/docs`
- ReDoc: `http://localhost:8000/redoc`

### Estructura del Proyecto

```
bus-cleaning-control/
‚îú‚îÄ‚îÄ backend/                 # API FastAPI
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api/            # Endpoints
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models/         # Modelos DB
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/       # L√≥gica de negocio
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main.py         # Entry point
‚îÇ   ‚îî‚îÄ‚îÄ requirements.txt
‚îú‚îÄ‚îÄ frontend/               # React App
‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/    # Componentes React
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pages/         # P√°ginas
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ stores/        # Zustand stores
‚îÇ   ‚îî‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ docker-compose.yml     # Orquestaci√≥n Docker
‚îî‚îÄ‚îÄ README.md              # Documentaci√≥n principal
```

### Comandos √ötiles

```bash
# Ver estado de servicios
docker compose ps

# Ver logs en vivo
docker compose logs -f [servicio]

# Reiniciar un servicio
docker compose restart [servicio]

# Ejecutar comando en contenedor
docker compose exec backend python -m app.scripts.create_admin
docker compose exec db psql -U buscontrol -d bus_cleaning

# Limpiar todo y empezar de cero
docker compose down -v
docker compose up -d
```

---

## üÜò Soporte

### Problemas Comunes

1. **Puerto ya en uso**: Cambia los puertos en `docker-compose.yml`
2. **Falta espacio en disco**: Limpia Docker: `docker system prune -a`
3. **Permisos en Linux**: Agrega tu usuario al grupo docker: `sudo usermod -aG docker $USER`

### Contacto

Para reportar bugs o solicitar features, crea un issue en el repositorio.

---

## ‚úÖ Verificaci√≥n Final

Para verificar que todo est√° funcionando:

1. ‚úÖ Backend responde: `curl http://localhost:8000/health`
2. ‚úÖ Frontend carga: Abre `http://localhost:5173`
3. ‚úÖ Login funciona: Usa `admin@buses.cl` / `Admin123!`
4. ‚úÖ WebSocket conecta: Verifica en consola del navegador (F12)
5. ‚úÖ Base de datos accesible: `docker compose exec db psql -U buscontrol -d bus_cleaning -c "\dt"`

Si todo lo anterior funciona: **¬°Felicidades! üéâ El sistema est√° completamente operativo.**

---

## üöÄ Pr√≥ximos Pasos

1. Crear usuarios operarios adicionales
2. Agregar PPUs (patentes) de buses
3. Empezar a registrar inspecciones
4. Explorar dashboard y reportes
5. Configurar alertas autom√°ticas
6. (Opcional) Entrenar modelo de IA personalizado

---

**¬°Listo para mejorar la calidad del transporte p√∫blico!** üöå‚ú®
